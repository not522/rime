#!/usr/bin/python

"""
Initialize a rime project.
"""

import os
import os.path
import sys

from six.moves import urllib


def make_file(path, content):
    with open(path, 'w') as f:
        f.write(content)


if __name__ == '__main__':
    if os.path.exists('project.json'):
        print('This directory is already a rime project root.')
        sys.exit(1)

    if len(sys.argv) < 2:
        print('Usage: rime_init.py --git / rime_init.py --mercurial')
        sys.exit(1)

    if sys.argv[1] == '--git':
        isgit = True
    elif sys.argv[1] == '--mercurial':
        isgit = False
    else:
        print('Usage: rime_init.py --git / rime_init.py --mercurial')
        sys.exit(1)

    content = '''\
rime-out
*.pyc
Icon*
*.swp
.DS_Store
Thumbs.db
*~
*.out
target
'''
    if isgit:
        make_file('.gitignore', content)
    else:
        make_file('.hgignore', 'syntax: glob\n' + content)

    if not os.path.exists('common'):
        os.makedirs('common')
    try:
        urllib.request.urlretrieve(
            'https://raw.githubusercontent.com/'
            'MikeMirzayanov/testlib/master/testlib.h',
            'common/testlib.h')
    except Exception:
        os.remove('project.json')
        print('Some error while downloading testlib.h.')
        sys.exit(1)

    content = '''\
{
    "library_dir":"common"
}
'''
    make_file('project.json', content)

    if(isgit):
        os.system('git init')
        os.system('git add project.json .gitignore common/testlib.h')
        os.system('git commit -m "Initial commit"')
    else:
        os.system('hg init')
        os.system('hg add project.json .hgignore common/testlib.h')
        os.system('hg commit -m "Initial commit"')
